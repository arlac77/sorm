#!/usr/bin/env node

"use strict";

var commander= require('commander')
   ,fs       = require('fs')
   ,os       = require("os")
   ,util     = require('util')
   ,path     = require('path')
   ,async    = require('async')
   ,pkginfo  = require('pkginfo')(module, 'name', 'version')
   ,sqlite3  = require('sqlite3')
   ,winston  = require('winston')
   ,schema   = require('../lib/schema.js');


winston.cli();

commander
  	.version(module.exports.version)
	.option('--database <file>', 'sqlite3 database file')
	.option('--schema <file>', 'schema definition file')
	.option('--ws', 'write schema from database into file')
	.option('--verbose', 'be more verbose')
  	.parse(process.argv);


var s;
var db;

if(commander.schema) {
	s = schema.Schema(commander.schema);
}

if(commander.database) {
	db = new sqlite3.Database(commander.database);

	//s = schema.Schema({});
	
	s.load_ddl_from_db(db,function(error) {
		
		if(commander.verbose) console.info(JSON.stringify(s.versions,undefined,'\t'));
		
		if(commander.ws) {
			s.save(function(error) {
				if(error)
					winston.error("Schema save error", error);
				else
					winston.info("Schema saved", s.basedir);
				});
			}
	});
}
